#!/bin/sh

# Send the header so that i3bar knows we want to use JSON:
echo '{ "version": 1, "click_events": true }'

# Begin the endless array.
echo '['

# We send an empty first array of blocks to make the loop simpler:
echo '[],'

# Now send blocks with information forever, forking off so that we can read inputs
conky -dc $HOME/.config/conky/conkyrc

while read;do
    IFS=" "
    STR=$(echo $REPLY | sed 's/[{}]//g;s/ "/"/g' | awk '{n=split($0,a,","); for (i=1; i<=n; i++) {m=split(a[i],b,":"); if (b[1] == "\"name\"") {NAME=b[2]} if (b[1] =="\"x\"") {X=b[2]} if (b[1] =="\"y\"") {Y=b[2]} } print NAME " " X " " Y}')
    read NAME X Y <<< "$STR"
    X=$((X-50))
    case "${NAME//\"}" in
        date)
            yad --no-buttons --geometry=+$((X-120))+$((Y-190)) --class "YADWIN" --calendar
            ;;
        volume)
            VOL=$(~/.config/i3/bin/volume get | grep -o '[0-9][0-9]*')
            NEWVOL=$(yad --text="Volume" --scale --value $VOL --button gtk-ok:0 --geometry=x200+$X+$((Y-215)) --class "YADWIN" --vertical --text-align center)
            if [[ $? == 0 ]]
            then
                echo foo > /tmp/foo
                ~/.config/conky/conkyexec ~/.config/i3/bin/volume set $NEWVOL
            fi
            ;;
        CPU)
            gnome-system-monitor -r
            ;;
        nvidia)
            nvidia-settings
            ;;
    esac
done
