#!/bin/bash
PICTURESDIR="$HOME/Pictures"
LOG="$HOME/.$(basename "$(readlink -f "$0")").log"
#set -x

exec > >(zenity --text-info) 2>&1
echo '' > "$LOG"

while [ -n "$*" ]
do
	if [[ ! -f "$1" ]]
	then
		echo "$1 is not a valid file! Skipping..."
	else
		if echo "$1" | grep -Eq '(pp3|xmp)$'
		then
			echo "Ignoring pp3/xmp: $1" >> "$LOG"
			echo '' >> "$LOG"
			shift
			continue
		fi
		echo "Sorting picture: $1"
		date=""
		ext=
		case "${1##*.}" in
			jpg|JPG)
				date=$(exiftool "$1"|grep "Date/Time Original"|awk '{print $4}'|sed 's/:/-/g')
				;;
			mp4|MP4)
				date=$(exiftool "$1"|grep "Media Create Date"|awk '{print $5}'|sed 's/:/-/g')
				;;
		esac

		# Fallback to date modified if it cannot be found
		[[ -z $date ]] && date=${date:-$(stat "$1"|grep Modify|awk '{print $2}')}

		outputdir=$PICTURESDIR/${date%%-*}/$date/

		echo "input: $1" >> "$LOG"
		echo "date: $date" >> "$LOG"
		echo "outputdir: $outputdir" >> "$LOG"
		echo "" >> "$LOG"

		output=""$(basename "$1")""
		mkdir -p "$outputdir"
		cp "$1" "$outputdir/${output//:nopm:}"
		[[ -f ${1}.pp3 ]] && cp "${1}.pp3" "$outputdir/${output//:nopm:}.pp3"
		[[ -f ${1}.xmp ]] && cp "${1}.xmp" "$outputdir/${output//:nopm:}.xmp"
		echo ''
	fi
	shift
done
